FROM node:24-alpine

WORKDIR /app
ENV NODE_ENV=production

# 1. 先拷贝 standalone 产物 (包含不兼容的 sharp)
COPY .next/standalone ./
COPY .next/static ./.next/static
COPY public ./public

# 2. 强制重新安装兼容 Alpine ARM 的 sharp
# 这一步会直接在当前目录的 node_modules 中覆盖掉旧的 sharp
RUN npm install sharp

# 3. 告诉 Next.js 优先使用这个 sharp
ENV NEXT_SHARP_PATH=/app/node_modules/sharp

EXPOSE 3000
CMD ["node", "server.js"]
