FROM node:24-alpine

WORKDIR /app
ENV NODE_ENV=production

# 1. 先拷贝产物
COPY .next/standalone ./
COPY .next/static ./.next/static
COPY public ./public

# 2. 强制安装 sharp，忽略 peerDependency 冲突
# --force 会绕过 ERESOLVE 错误
RUN npm install sharp --force --no-package-lock
# 或显式指定平台，避免 npm 去校验其它无关的 UI 组件依赖
# RUN npm install --os=linux --libc=musl --cpu=arm64 sharp

# 3. 设置环境变量指向正确的 sharp
ENV NEXT_SHARP_PATH=/app/node_modules/sharp

EXPOSE 3000
CMD ["node", "server.js"]
